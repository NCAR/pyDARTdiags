
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/01_manipulating/plot_external_fo.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_01_manipulating_plot_external_fo.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_01_manipulating_plot_external_fo.py:


Adding External Forward Operators to an Observation
===================================================

External, or "precomputed" forward operators are forward operators
that are not calculated during ``filter``, DART's assimilation program. 
They are calculated externally, written to an observation sequence file,
and read in by ``filter``.  

This example shows how to add an external forward operator to an observation.
We'll be using observations for the Lorenz 96 tracer model, which is a toy
model used to test assimilation algorithms.  We are going to create some 
RAW_TRACER_CONCENTRATION forward operators.

.. GENERATED FROM PYTHON SOURCE LINES 18-19

Import the obs_sequence module, and numpy

.. GENERATED FROM PYTHON SOURCE LINES 19-23

.. code-block:: Python

    import pydartdiags.obs_sequence.obs_sequence as obsq
    from pydartdiags.data import get_example_data
    import numpy as np








.. GENERATED FROM PYTHON SOURCE LINES 24-27

Read in the observation sequence file. In this example we'll use the
obs_seq.out.tracer file.
This file only has two observations.

.. GENERATED FROM PYTHON SOURCE LINES 27-30

.. code-block:: Python

    data_file = get_example_data("obs_seq.out.tracer")
    obs_seq = obsq.ObsSequence(data_file)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    package_dir: /home/runner/work/pyDARTdiags/pyDARTdiags
    Using development data file: /home/runner/work/pyDARTdiags/pyDARTdiags/data/obs_seq.out.tracer




.. GENERATED FROM PYTHON SOURCE LINES 31-34

.. code-block:: Python

    obs_seq.df







.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>
    <style scoped>
        .dataframe tbody tr th:only-of-type {
            vertical-align: middle;
        }

        .dataframe tbody tr th {
            vertical-align: top;
        }

        .dataframe thead th {
            text-align: right;
        }
    </style>
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th></th>
          <th>obs_num</th>
          <th>observation</th>
          <th>truth</th>
          <th>Quality_Control</th>
          <th>linked_list</th>
          <th>location</th>
          <th>type</th>
          <th>metadata</th>
          <th>external_FO</th>
          <th>seconds</th>
          <th>days</th>
          <th>time</th>
          <th>obs_err_var</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>0</th>
          <td>1</td>
          <td>2.072563</td>
          <td>1.648863</td>
          <td>0.0</td>
          <td>-1           2          -1</td>
          <td>0.097632</td>
          <td>RAW_TRACER_CONCENTRATION</td>
          <td>[]</td>
          <td>[]</td>
          <td>0</td>
          <td>0</td>
          <td>2000-01-01</td>
          <td>10.01</td>
        </tr>
        <tr>
          <th>1</th>
          <td>2</td>
          <td>0.509401</td>
          <td>0.715153</td>
          <td>0.0</td>
          <td>1           -1          -1</td>
          <td>0.111607</td>
          <td>RAW_STATE_VARIABLE</td>
          <td>[]</td>
          <td>[]</td>
          <td>0</td>
          <td>0</td>
          <td>2000-01-01</td>
          <td>9.99</td>
        </tr>
      </tbody>
    </table>
    </div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 35-37

The external forward operator is stored in the 'external_FO' column.
Currently, the 'external_FO' column is empty.

.. GENERATED FROM PYTHON SOURCE LINES 37-40

.. code-block:: Python

    obs_seq.df.iloc[0]['external_FO']






.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    []



.. GENERATED FROM PYTHON SOURCE LINES 41-47

Let's add a forward operator to the RAW_TRACER_CONCENTRATION observation.
For this example, we're going to use random numbers to create our ensemble
of forward operators. For a scientific experiment, you would use appropriate 
forward operator results from your model. 
We want 80 ensemble members, so we'll create 80 random numbers, and we want tracer
concentrations, so we'll force the numbers to be positive.

.. GENERATED FROM PYTHON SOURCE LINES 47-50

.. code-block:: Python

    n = 80
    random_numbers = np.abs(np.random.normal(loc=0.75, scale=0.1, size=n)).tolist()








.. GENERATED FROM PYTHON SOURCE LINES 51-55

DART observation sequence files have a specific format. DART expects the list
of forward operators to have 'external_FO' followed by the number of ensemble
members, followed by the 'key' for the forward operator. The 'key' is not 
used by DART, so we will just put 1 for the value. 

.. GENERATED FROM PYTHON SOURCE LINES 55-57

.. code-block:: Python

    random_numbers.insert(0, f'external_FO {n} 1')








.. GENERATED FROM PYTHON SOURCE LINES 58-59

Now we can add the forward operator to the 'external_FO' column for row 0

.. GENERATED FROM PYTHON SOURCE LINES 59-61

.. code-block:: Python

    obs_seq.df.at[0,'external_FO'].extend(random_numbers)








.. GENERATED FROM PYTHON SOURCE LINES 62-63

Now the 'external_FO' column has the forward operator.

.. GENERATED FROM PYTHON SOURCE LINES 63-65

.. code-block:: Python

    obs_seq.df.iloc[0]['external_FO']





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    ['external_FO 80 1', 0.8946045195916809, 0.7378243371850928, 0.6496292789925879, 0.7222834373230407, 0.638038584219026, 0.9305660253209492, 0.7414003983505357, 0.6652851710838356, 0.6872648259590398, 0.8560297569519997, 0.8917348288875104, 0.474958877346913, 0.7473461003657228, 0.7065946718702951, 0.8674469451253968, 0.673801829803144, 0.9099091422355444, 0.7527141497452357, 0.6159891486597142, 0.7501019523061848, 0.6611675146058011, 0.7142085304068396, 0.5855028387534706, 0.7412553410673227, 0.6772310842893203, 0.7521974131254229, 0.749867327027255, 0.6184481012249397, 0.7224140207201042, 0.7054233954915357, 0.788038561287448, 0.7492507313728407, 0.779690995296002, 0.6977015937152012, 0.9001394804065196, 0.8611527304791966, 0.7329503976372546, 0.8659746215230109, 0.5909204287706149, 0.9159341021267764, 0.7852856880146863, 0.8183161379933145, 0.6200829950543351, 0.6482186752970088, 0.7511548524272659, 0.647726121832088, 0.8647650024003302, 0.7702447765664792, 0.9192033772725524, 0.65420406193449, 0.7516354728383386, 0.6764571338032789, 0.7922479534571502, 0.7762974557581461, 0.6299041917674386, 0.6575791579263908, 0.8411413773334471, 0.7672309214752114, 0.7183112143785043, 0.6078247250942763, 0.7323874756273449, 0.8129086277621826, 0.7932151565089193, 0.9723702068500768, 0.9368848494212771, 0.7486456516534397, 0.6731725150997888, 0.763355840364094, 0.7113740956354414, 0.6759317111365638, 0.7447329722734488, 0.7360898066566972, 0.6468142634647007, 0.731542719156891, 0.782911529819497, 0.8569618269399414, 0.6446184066419969, 0.6523093949426498, 0.8024571754833063, 0.7553928037983596]



.. GENERATED FROM PYTHON SOURCE LINES 66-67

Let's write the observation sequence file with the new forward operator.

.. GENERATED FROM PYTHON SOURCE LINES 67-68

.. code-block:: Python

    obs_seq.write_obs_seq('obs_seq.out.tracer_with_external_FO')








.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 0.009 seconds)


.. _sphx_glr_download_examples_01_manipulating_plot_external_fo.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_external_fo.ipynb <plot_external_fo.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_external_fo.py <plot_external_fo.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_external_fo.zip <plot_external_fo.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
